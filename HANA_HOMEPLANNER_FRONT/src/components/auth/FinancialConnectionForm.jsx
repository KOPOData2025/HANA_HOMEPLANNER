import React, { useState, useEffect } from 'react';
import toast from 'react-hot-toast';
import { 
  ArrowLeft, 
  Building2,
  CreditCard,
  TrendingUp,
  Shield,
  CheckCircle,
  Loader2
} from "lucide-react";
import { useInviteSignup } from '@/hooks/useInviteSignup';
import { getCiFromLocal } from '@/utils/ciUtils';
import { useMyData } from '@/hooks/useMyData';
import { INSTITUTION_TYPE_COLORS, INSTITUTION_TYPE_BG_COLORS } from '@/utils/financialInstitutionUtils';

const FinancialConnectionForm = ({ 
  initialData, 
  onComplete, 
  onBack 
}) => {
  const { processInviteSignup, isLoading: isSignupLoading } = useInviteSignup();
  const { fetchMyData, myData, isLoading: isMyDataLoading, error: myDataError } = useMyData();
  
  const [isConnecting, setIsConnecting] = useState(false);
  const [connectionProgress, setConnectionProgress] = useState(0);
  const [currentConnecting, setCurrentConnecting] = useState('');
  const [selectedFinancialItems, setSelectedFinancialItems] = useState({
    bankAccounts: [],
    cards: [],
    bankLoans: [],
    cardLoans: [],
    installmentLoans: [],
    insuranceLoans: []
  });

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
  useEffect(() => {
    const ci = getCiFromLocal();
    if (ci) {
      console.log('üîç CI Í∞íÏúºÎ°ú ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå ÏãúÏûë:', ci);
      fetchMyData(ci);
    } else {
      console.log('‚ö†Ô∏è CI Í∞íÏù¥ ÏóÜÏñ¥ÏÑú ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞ÌöåÎ•º Í±¥ÎÑàÎúÅÎãàÎã§.');
    }
  }, [fetchMyData]);

  // ÏÑπÏÖò ÌôïÏû•/Ï∂ïÏÜå ÌÜ†Í∏Ä
  const toggleSection = (sectionKey) => {
    setExpandedSections(prev => ({
      ...prev,
      [sectionKey]: !prev[sectionKey]
    }));
  };

  // Í∏àÏï° Ìè¨Îß∑ÌåÖ
  const formatAmount = (amount) => {
    if (!amount) return '0Ïõê';
    return new Intl.NumberFormat('ko-KR').format(amount) + 'Ïõê';
  };

  // Í≥ÑÏ¢åÎ≤àÌò∏ ÎßàÏä§ÌÇπ
  const maskAccountNumber = (accountNum) => {
    if (!accountNum) return '';
    if (accountNum.length <= 8) return accountNum;
    return accountNum.substring(0, 4) + '****' + accountNum.substring(accountNum.length - 4);
  };

  // Ïπ¥ÎìúÎ≤àÌò∏ ÎßàÏä§ÌÇπ
  const maskCardNumber = (cardNum) => {
    if (!cardNum) return '';
    return cardNum.replace(/\d{4}(?=\d{4})/g, '****');
  };

  // Í∏àÏúµ ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù/Ìï¥Ï†ú
  const toggleFinancialItem = (category, itemId) => {
    setSelectedFinancialItems(prev => ({
      ...prev,
      [category]: prev[category].includes(itemId)
        ? prev[category].filter(id => id !== itemId)
        : [...prev[category], itemId]
    }));
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú
  const toggleCategorySelection = (category, items) => {
    const allIds = items.map(item => item.accountId || item.cardId || item.loanId || item.cardLoanId || item.instLoanId || item.insLoanId);
    const isAllSelected = allIds.every(id => selectedFinancialItems[category].includes(id));
    
    setSelectedFinancialItems(prev => ({
      ...prev,
      [category]: isAllSelected ? [] : allIds
    }));
  };

  // ÏÑ†ÌÉùÎêú Ï¥ù ÏïÑÏù¥ÌÖú Ïàò Í≥ÑÏÇ∞
  const getTotalSelectedItems = () => {
    return Object.values(selectedFinancialItems).flat().length;
  };

  // Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú
  const toggleAllFinancialItems = () => {
    if (!myData) return;

    const allItems = [
      ...(myData.bankAccounts || []),
      ...(myData.cards || []),
      ...(myData.bankLoans || []),
      ...(myData.cardLoans || []),
      ...(myData.installmentLoans || []),
      ...(myData.insuranceLoans || [])
    ];

    const totalItems = allItems.length;
    const currentSelected = getTotalSelectedItems();
    
    // ÌòÑÏû¨ Î™®Îì† ÏïÑÏù¥ÌÖúÏù¥ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï†ÑÏ≤¥ Ìï¥Ï†ú, ÏïÑÎãàÎ©¥ Ï†ÑÏ≤¥ ÏÑ†ÌÉù
    const isAllSelected = currentSelected === totalItems;
    
    if (isAllSelected) {
      // Ï†ÑÏ≤¥ Ìï¥Ï†ú
      setSelectedFinancialItems({
        bankAccounts: [],
        cards: [],
        bankLoans: [],
        cardLoans: [],
        installmentLoans: [],
        insuranceLoans: []
      });
    } else {
      // Ï†ÑÏ≤¥ ÏÑ†ÌÉù
      const newSelection = {};
      Object.keys(selectedFinancialItems).forEach(category => {
        const items = myData[category] || [];
        newSelection[category] = items.map(item => 
          item.accountId || item.cardId || item.loanId || item.cardLoanId || item.instLoanId || item.insLoanId
        );
      });
      setSelectedFinancialItems(newSelection);
    }
  };

  // Í∏àÏúµ ÏïÑÏù¥ÌÖú Ïπ¥Îìú Î†åÎçîÎßÅ
  const renderFinancialItemCard = (item, category, type) => {
    const itemId = item.accountId || item.cardId || item.loanId || item.cardLoanId || item.instLoanId || item.insLoanId;
    const isSelected = selectedFinancialItems[category].includes(itemId);
    
    return (
      <div
        key={itemId}
        onClick={() => toggleFinancialItem(category, itemId)}
        className={`p-4 rounded-lg border-2 cursor-pointer transition-all duration-200 ${
          isSelected 
            ? 'border-teal-500 bg-teal-50 shadow-md' 
            : 'border-gray-200 hover:border-gray-300 bg-white hover:shadow-sm'
        }`}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
              {item.institution.logo.startsWith('/') ? (
                <img 
                  src={item.institution.logo} 
                  alt={item.institution.name} 
                  className="w-8 h-8 object-contain"
                  onError={(e) => {
                    e.target.style.display = 'none';
                    e.target.nextSibling.style.display = 'block';
                  }}
                />
              ) : null}
              <span 
                className={`text-xs font-bold text-gray-600 ${item.institution.logo.startsWith('/') ? 'hidden' : 'block'}`}
                style={{ display: item.institution.logo.startsWith('/') ? 'none' : 'block' }}
              >
                {item.institution.logo}
              </span>
            </div>
            <div>
              <div className="font-medium text-gray-800">
                {item.accountName || item.cardName || item.loanType || item.productName}
              </div>
              <div className="text-sm text-gray-600">{item.institution.name}</div>
              <div className="text-xs text-gray-500">
                {item.accountNum ? maskAccountNumber(item.accountNum) : 
                 item.cardNum ? maskCardNumber(item.cardNum) : 
                 item.accountType || item.cardType || ''}
              </div>
            </div>
          </div>
          <div className="text-right">
            {item.balanceAmt !== undefined && (
              <div className={`font-semibold ${
                category.includes('Loan') ? 'text-red-700' : 'text-gray-800'
              }`}>
                {formatAmount(item.balanceAmt)}
              </div>
            )}
            {item.intRate && (
              <div className="text-xs text-gray-500">{item.intRate}%</div>
            )}
            {isSelected && (
              <CheckCircle className="w-5 h-5 text-teal-600 mt-1" />
            )}
          </div>
        </div>
      </div>
    );
  };

  // Í∏àÏúµ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑπÏÖò Î†åÎçîÎßÅ
  const renderFinancialCategory = (title, items, category, icon, emptyMessage) => {
    if (!items || items.length === 0) return null;

    const allIds = items.map(item => item.accountId || item.cardId || item.loanId || item.cardLoanId || item.instLoanId || item.insLoanId);
    const isAllSelected = allIds.every(id => selectedFinancialItems[category].includes(id));
    const selectedCount = selectedFinancialItems[category].length;

    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-2">
            {icon}
            <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
            <span className="text-sm text-gray-500">
              ({selectedCount}/{items.length}Í∞ú ÏÑ†ÌÉù)
            </span>
          </div>
          
          <button
            type="button"
            onClick={() => toggleCategorySelection(category, items)}
            className={`px-3 py-1 rounded-md text-sm font-medium transition-colors ${
              isAllSelected
                ? 'bg-gray-500 hover:bg-gray-600 text-white'
                : 'bg-teal-600 hover:bg-teal-700 text-white'
            }`}
          >
            {isAllSelected ? 'Ï†ÑÏ≤¥ Ìï¥Ï†ú' : 'Î™®Îëê ÏÑ†ÌÉù'}
          </button>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {items.map((item) => renderFinancialItemCard(item, category, title))}
        </div>
      </div>
    );
  };

  const handleConnect = async () => {
    if (!myData) {
      toast.error('ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞ÌöåÍ∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
      return;
    }

    setIsConnecting(true);
    setConnectionProgress(0);
    setCurrentConnecting('ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ïó∞ÎèôÏ§ë...');

    try {
      // 1Îã®Í≥Ñ: ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ïó∞Îèô Ïï†ÎãàÎ©îÏù¥ÏÖò (2Ï¥à)
      const duration = 2000;
      const interval = 50;
      let elapsed = 0;

      const progressTimer = setInterval(async () => {
        elapsed += interval;
        const progress = (elapsed / duration) * 50; // 50%ÍπåÏßÄÎßå (ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ïó∞Îèô)
        setConnectionProgress(Math.min(progress, 50));
        
        if (elapsed >= duration) {
          clearInterval(progressTimer);
          
          try {
            // 2Îã®Í≥Ñ: Ïã§Ï†ú ÌöåÏõêÍ∞ÄÏûÖ API Ìò∏Ï∂ú
            setCurrentConnecting('ÌöåÏõêÍ∞ÄÏûÖ Ï≤òÎ¶¨Ï§ë...');
            setConnectionProgress(60);
            
            // ÏÑ†ÌÉùÎêú Í∏àÏúµ ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥ Ï∂îÏ∂ú
            const getSelectedFinancialItems = () => {
              const selectedItems = {};
              
              Object.keys(selectedFinancialItems).forEach(category => {
                const selectedIds = selectedFinancialItems[category];
                if (selectedIds.length > 0) {
                  selectedItems[category] = myData[category]?.filter(item => {
                    const itemId = item.accountId || item.cardId || item.loanId || item.cardLoanId || item.instLoanId || item.insLoanId;
                    return selectedIds.includes(itemId);
                  }) || [];
                }
              });
              
              return selectedItems;
            };

            // ÌöåÏõêÍ∞ÄÏûÖ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ (ÏÑ†ÌÉùÎêú Í∏àÏúµ ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥ Ìè¨Ìï®)
            const signupData = {
              ...initialData,
              myData: myData, // ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï†ÑÏ≤¥ Ï†ïÎ≥¥ Ìè¨Ìï®
              selectedFinancialItems: getSelectedFinancialItems(), // ÏÑ†ÌÉùÎêú Í∏àÏúµ ÏïÑÏù¥ÌÖúÎßå Ìè¨Ìï®
              totalSelectedItems: getTotalSelectedItems(),
              connectionDate: new Date().toISOString(),
              // ÌïÑÏöîÌïú Ï∂îÍ∞Ä ÌïÑÎìúÎì§
              phnNum: initialData.phnNum || '010-0000-0000',
              resNum: '123456-1234567', // Ï£ºÎØºÎ≤àÌò∏Îäî Ïã§Ï†úÎ°úÎäî ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Î∞õÏïÑÏïº Ìï®
              ci: initialData.ci || getCiFromLocal() // CI Í∞í Ìè¨Ìï®
            };

            console.log('ÏµúÏ¢Ö ÌöåÏõêÍ∞ÄÏûÖ Îç∞Ïù¥ÌÑ∞ (ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®):', signupData);
            
            setConnectionProgress(80);
            
            // Ï¥àÎåÄ ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ Ï¥àÎåÄ ÌöåÏõêÍ∞ÄÏûÖ, ÏóÜÏúºÎ©¥ ÏùºÎ∞ò ÌöåÏõêÍ∞ÄÏûÖ
            if (signupData.inviteToken) {
              setCurrentConnecting('Ïª§Ìîå Ïó∞Í≤∞ Ï≤òÎ¶¨Ï§ë...');
              await processInviteSignup(signupData);
            } else {
              // ÏùºÎ∞ò ÌöåÏõêÍ∞ÄÏûÖÏùò Í≤ΩÏö∞ Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ
              setConnectionProgress(100);
              setCurrentConnecting('ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å!');
              
              setTimeout(() => {
                onComplete(signupData);
              }, 500);
            }
            
          } catch (apiError) {
            console.error('ÌöåÏõêÍ∞ÄÏûÖ API Ïò§Î•ò:', apiError);
            toast.error('ÌöåÏõêÍ∞ÄÏûÖ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            setIsConnecting(false);
            setConnectionProgress(0);
            setCurrentConnecting('');
          }
        }
      }, interval);

    } catch (error) {
      console.error('Ïó∞Îèô Í≥ºÏ†ï Ïò§Î•ò:', error);
      toast.error('ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ïó∞Îèô Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      setIsConnecting(false);
      setConnectionProgress(0);
      setCurrentConnecting('');
    }
  };


  if (isConnecting) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="bg-white rounded-lg shadow-sm p-8 max-w-md w-full mx-4">
          <div className="text-center">
            <div className="mb-6">
              <Loader2 className="w-16 h-16 mx-auto text-teal-600 animate-spin" />
            </div>
            
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              Í∏àÏúµÍ∏∞Í¥Ä Ïó∞Í≤∞ Ï§ë
            </h2>
            
            <p className="text-gray-600 mb-6">{currentConnecting}</p>
            
            {/* ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î */}
            <div className="w-full bg-gray-200 rounded-full h-3 mb-4">
              <div 
                className="bg-gradient-to-r from-teal-500 to-blue-500 h-3 rounded-full transition-all duration-500 ease-out"
                style={{ width: `${connectionProgress}%` }}
              ></div>
            </div>
            
            <p className="text-sm text-gray-500">
              {Math.round(connectionProgress)}% ÏôÑÎ£å
            </p>
            
            <div className="mt-6 text-xs text-gray-400">
              üí° ÏïàÏ†ÑÌïú ÏïîÌò∏Ìôî ÌÜµÏã†ÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Î≥¥Ìò∏ÌïòÍ≥† ÏûàÏäµÎãàÎã§
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-16">
      <div className="container mx-auto max-w-4xl px-6">
        {/* Ìó§Îçî */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center mb-4">
            <button 
              onClick={onBack}
              className="absolute left-6 flex items-center text-gray-600 hover:text-gray-800 transition-colors"
            >
              <ArrowLeft className="w-5 h-5 mr-2" />
              Îí§Î°ú
            </button>
            <h1 className="text-3xl font-bold text-gray-800">Í∏àÏúµÍ∏∞Í¥Ä Ïó∞Í≤∞</h1>
          </div>
          <p className="text-gray-600">ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ ÏÑúÎπÑÏä§ Ïù¥Ïö©ÏùÑ ÏúÑÌï¥ Í∏àÏúµÍ∏∞Í¥ÄÏùÑ Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî</p>
        </div>

        <div className="bg-white rounded-lg shadow-sm p-8">
          <div className="space-y-8">
            {/* ÏïàÎÇ¥ Î©îÏãúÏßÄ */}
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex items-start space-x-3">
                <Shield className="w-5 h-5 text-blue-600 mt-0.5" />
                <div>
                  <h4 className="font-medium text-blue-800 mb-1">ÏïàÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞</h4>
                  <p className="text-sm text-blue-700">
                    Í∏àÏúµÏúÑÏõêÌöå Ïù∏Ï¶ùÏùÑ Î∞õÏùÄ ÏïàÏ†ÑÌïú ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ ÏÑúÎπÑÏä§ÏûÖÎãàÎã§. 
                    ÏÑ†ÌÉùÌïòÏã† Í∏àÏúµÍ∏∞Í¥ÄÏùò Îç∞Ïù¥ÌÑ∞Îßå ÏàòÏßëÎêòÎ©∞, Ïñ∏Ï†úÎì†ÏßÄ Ïó∞Í≤∞ÏùÑ Ìï¥Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.
                  </p>
                </div>
              </div>
            </div>

            {/* ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Í≤∞Í≥º */}
            {isMyDataLoading && (
              <div className="bg-gray-50 border border-gray-200 rounded-lg p-6">
                <div className="flex items-center justify-center space-x-3">
                  <Loader2 className="w-5 h-5 text-teal-600 animate-spin" />
                  <span className="text-gray-700">ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë...</span>
                </div>
              </div>
            )}

            {myDataError && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="flex items-start space-x-3">
                  <Shield className="w-5 h-5 text-red-600 mt-0.5" />
                  <div>
                    <h4 className="font-medium text-red-800 mb-1">ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®</h4>
                    <p className="text-sm text-red-700">{myDataError}</p>
                  </div>
                </div>
              </div>
            )}

            {/* Ï°∞ÌöåÎêú ÏÇ¨Ïö©ÏûêÏùò Í∏àÏúµ Ï†ïÎ≥¥ Ìó§Îçî */}
            {myData && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <CheckCircle className="w-6 h-6 text-green-600" />
                    <div>
                      <h4 className="font-semibold text-green-800">Ï°∞ÌöåÎêú ÏÇ¨Ïö©ÏûêÏùò Í∏àÏúµ Ï†ïÎ≥¥</h4>
                      <p className="text-sm text-green-700">
                        Ï¥ù {myData.summary?.totalAccountCount || 0}Í∞ú Í≥ÑÏ¢å, {myData.summary?.totalCardCount || 0}Í∞ú Ïπ¥Îìú, {myData.summary?.totalLoanCount || 0}Í∞ú ÎåÄÏ∂úÏù¥ ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§.
                      </p>
                    </div>
                  </div>
                  
                  {/* Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú Î≤ÑÌäº */}
                  <button
                    type="button"
                    onClick={toggleAllFinancialItems}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                      getTotalSelectedItems() === 0
                        ? 'bg-teal-600 hover:bg-teal-700 text-white'
                        : getTotalSelectedItems() === (myData.summary?.totalAccountCount || 0) + (myData.summary?.totalCardCount || 0) + (myData.summary?.totalLoanCount || 0)
                        ? 'bg-gray-500 hover:bg-gray-600 text-white'
                        : 'bg-teal-600 hover:bg-teal-700 text-white'
                    }`}
                  >
                    {getTotalSelectedItems() === 0
                      ? 'Î™®Îëê ÏÑ†ÌÉù'
                      : getTotalSelectedItems() === (myData.summary?.totalAccountCount || 0) + (myData.summary?.totalCardCount || 0) + (myData.summary?.totalLoanCount || 0)
                      ? 'Ï†ÑÏ≤¥ Ìï¥Ï†ú'
                      : 'Î™®Îëê ÏÑ†ÌÉù'
                    }
                  </button>
                </div>
              </div>
            )}

            {/* ÏùÄÌñâ Í≥ÑÏ¢å ÏÑπÏÖò */}
            {myData && myData.bankAccounts && myData.bankAccounts.length > 0 && (
              <div className="bg-white border border-gray-200 rounded-lg p-6">
                {renderFinancialCategory(
                  'ÏùÄÌñâ Í≥ÑÏ¢å',
                  myData.bankAccounts,
                  'bankAccounts',
                  <Building2 className="w-5 h-5 text-blue-600" />
                )}
              </div>
            )}

            {/* Ïπ¥Îìú ÏÑπÏÖò */}
            {myData && myData.cards && myData.cards.length > 0 && (
              <div className="bg-white border border-gray-200 rounded-lg p-6">
                {renderFinancialCategory(
                  'Ïπ¥Îìú',
                  myData.cards,
                  'cards',
                  <CreditCard className="w-5 h-5 text-purple-600" />
                )}
              </div>
            )}

            {/* ÏùÄÌñâ ÎåÄÏ∂ú ÏÑπÏÖò */}
            {myData && myData.bankLoans && myData.bankLoans.length > 0 && (
              <div className="bg-white border border-gray-200 rounded-lg p-6">
                {renderFinancialCategory(
                  'ÏùÄÌñâ ÎåÄÏ∂ú',
                  myData.bankLoans,
                  'bankLoans',
                  <Building2 className="w-5 h-5 text-blue-600" />
                )}
              </div>
            )}

            {/* Ïπ¥Îìú ÎåÄÏ∂ú ÏÑπÏÖò */}
            {myData && myData.cardLoans && myData.cardLoans.length > 0 && (
              <div className="bg-white border border-gray-200 rounded-lg p-6">
                {renderFinancialCategory(
                  'Ïπ¥Îìú ÎåÄÏ∂ú',
                  myData.cardLoans,
                  'cardLoans',
                  <CreditCard className="w-5 h-5 text-purple-600" />
                )}
              </div>
            )}

            {/* Ìï†Î∂Ä ÎåÄÏ∂ú ÏÑπÏÖò */}
            {myData && myData.installmentLoans && myData.installmentLoans.length > 0 && (
              <div className="bg-white border border-gray-200 rounded-lg p-6">
                {renderFinancialCategory(
                  'Ìï†Î∂Ä ÎåÄÏ∂ú',
                  myData.installmentLoans,
                  'installmentLoans',
                  <TrendingUp className="w-5 h-5 text-green-600" />
                )}
              </div>
            )}

            {/* Î≥¥Ìóò ÎåÄÏ∂ú ÏÑπÏÖò */}
            {myData && myData.insuranceLoans && myData.insuranceLoans.length > 0 && (
              <div className="bg-white border border-gray-200 rounded-lg p-6">
                {renderFinancialCategory(
                  'Î≥¥Ìóò ÎåÄÏ∂ú',
                  myData.insuranceLoans,
                  'insuranceLoans',
                  <Shield className="w-5 h-5 text-orange-600" />
                )}
              </div>
            )}



            {/* Ïó∞Í≤∞ Î≤ÑÌäº */}
            <div className="pt-6 border-t">
              <div className="flex items-center justify-between mb-4">
                <div className="text-gray-600">
                  {myData ? (
                    <>
                      Ï¥ù <span className="font-semibold text-teal-600">{getTotalSelectedItems()}Í∞ú</span> Í∏àÏúµ ÏÉÅÌíà ÏÑ†ÌÉùÎê®
                    </>
                  ) : (
                    <span className="font-semibold text-gray-500">ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë...</span>
                  )}
                </div>
                {myData && getTotalSelectedItems() > 0 && (
                  <div className="text-sm text-gray-500">
                    ÏÑ†ÌÉùÎêú Í∏àÏúµ ÏÉÅÌíà Ï†ïÎ≥¥Í∞Ä ÌöåÏõêÍ∞ÄÏûÖÏóê Ìè¨Ìï®Îê©ÎãàÎã§
                  </div>
                )}
              </div>
              
              {isConnecting ? (
                <div className="space-y-4">
                  <div className="bg-gray-50 rounded-lg p-4">
                    <div className="flex items-center justify-center space-x-3 mb-3">
                      <Loader2 className="w-5 h-5 text-teal-600 animate-spin" />
                      <span className="text-gray-700 font-medium">{currentConnecting}</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                      <div 
                        className="bg-teal-600 h-2 rounded-full transition-all duration-300"
                        style={{ width: `${connectionProgress}%` }}
                      ></div>
                    </div>
                    <p className="text-center text-sm text-gray-500 mt-2">
                      {Math.round(connectionProgress)}% ÏôÑÎ£å
                    </p>
                  </div>
                </div>
              ) : (
                <>
                  <button
                    type="button"
                    onClick={handleConnect}
                    disabled={!myData || isMyDataLoading}
                    className={`w-full py-3 px-4 rounded-lg font-medium transition-colors ${
                      !myData || isMyDataLoading
                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        : 'bg-teal-600 hover:bg-teal-700 text-white'
                    }`}
                  >
                    {isMyDataLoading 
                      ? 'ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë...' 
                      : !myData 
                        ? 'ÎßàÏù¥Îç∞Ïù¥ÌÑ∞ Ï°∞ÌöåÎ•º Í∏∞Îã§Î¶¨Îäî Ï§ë...'
                        : getTotalSelectedItems() === 0
                          ? 'Í∏àÏúµ ÏÉÅÌíà ÏóÜÏù¥ ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£åÌïòÍ∏∞'
                          : `${getTotalSelectedItems()}Í∞ú Í∏àÏúµ ÏÉÅÌíàÏúºÎ°ú ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£åÌïòÍ∏∞`
                    }
                  </button>
                  
                  {myData && getTotalSelectedItems() > 0 && (
                    <p className="text-center text-sm text-gray-500 mt-3">
                      ÏÑ†ÌÉùÎêú Í∏àÏúµ ÏÉÅÌíà Ï†ïÎ≥¥Í∞Ä ÌöåÏõêÍ∞ÄÏûÖÏóê Ìè¨Ìï®Îê©ÎãàÎã§
                    </p>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default FinancialConnectionForm;
